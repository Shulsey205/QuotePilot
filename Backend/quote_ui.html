<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>QuotePilot Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: #0f172a;
            color: #e5e7eb;
        }

        .page {
            max-width: 960px;
            margin: 0 auto;
            padding: 24px 16px 48px;
        }

        header {
            margin-bottom: 24px;
        }

        header h1 {
            font-size: 1.75rem;
            margin: 0 0 4px;
        }

        header p {
            margin: 0;
            color: #9ca3af;
            font-size: 0.95rem;
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
            gap: 20px;
        }

        @media (max-width: 800px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: #020617;
            border-radius: 12px;
            padding: 16px 16px 20px;
            border: 1px solid #1f2937;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .card h2 {
            margin: 0 0 12px;
            font-size: 1.1rem;
        }

        label {
            display: block;
            font-size: 0.85rem;
            color: #9ca3af;
            margin-bottom: 6px;
        }

        select,
        input,
        textarea {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #4b5563;
            padding: 8px 10px;
            font-size: 0.95rem;
            background: #020617;
            color: #e5e7eb;
            box-sizing: border-box;
        }

        textarea {
            min-height: 90px;
            resize: vertical;
        }

        select:focus,
        input:focus,
        textarea:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 1px #22c55e33;
        }

        .field {
            margin-bottom: 12px;
        }

        .hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 4px;
        }

        .button-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        button {
            border-radius: 999px;
            border: none;
            padding: 8px 18px;
            font-size: 0.9rem;
            cursor: pointer;
            background: #22c55e;
            color: #020617;
            font-weight: 600;
        }

        button:disabled {
            opacity: 0.6;
            cursor: wait;
        }

        .status {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
        }

        .price {
            font-size: 1.4rem;
            font-weight: 600;
            color: #22c55e;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            background: #111827;
            border: 1px solid #1f2937;
            font-size: 0.75rem;
            color: #9ca3af;
            margin-right: 6px;
        }

        .result-meta {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 4px;
            font-size: 0.78rem;
        }

        th,
        td {
            padding: 6px 4px;
            text-align: left;
        }

        th {
            border-bottom: 1px solid #1f2937;
            color: #9ca3af;
            font-weight: 500;
        }

        tr:nth-child(even) td {
            background: #020617;
        }

        .disclaimer {
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: 10px;
        }

        .empty-state {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 4px;
        }

        .error {
            font-size: 0.8rem;
            color: #f97373;
            margin-top: 8px;
        }
    </style>
</head>
<body>
<div class="page">
    <header>
        <h1>QuotePilot Demo</h1>
        <p>
            Turn industrial instrument requests into complete part numbers and pricing, using your rules.
        </p>
    </header>

    <div class="layout">
        <section class="card">
            <h2>Request a quote</h2>

            <div class="field">
                <label for="model">Model</label>
                <select id="model">
                    <option value="QPSAH200S">QPSAH200S – DP Transmitter</option>
                    <option value="QPMAG">QPMAG – Mag Meter</option>
                </select>
            </div>

            <div class="field">
                <label for="mode">Input type</label>
                <select id="mode">
                    <option value="part_number">Exact part number</option>
                    <option value="natural_language">Natural language request</option>
                </select>
            </div>

            <div class="field" id="part-number-field">
                <label for="part-number">Part number</label>
                <input
                    id="part-number"
                    type="text"
                    value="QPSAH200S-A-M-G-3-C-3-1-1-C-1-02"
                />
                <div class="hint">
                    You can paste or edit any valid QuotePilot part number.
                </div>
            </div>

            <div class="field" id="nl-field" style="display:none;">
                <label for="request-text">Natural language request</label>
                <textarea id="request-text"
                          placeholder="For example: 0–200 inH₂O DP transmitter, 4–20 mA, 3-valve manifold, 316SS, remote mount…"></textarea>
                <div class="hint">
                    QuotePilot will choose a compatible configuration and build the part number for you.
                </div>
            </div>

            <div class="button-row">
                <button id="quote-button">Get quote</button>
                <span class="status" id="status-text"></span>
            </div>

            <div id="error-text" class="error"></div>
        </section>

        <section class="card">
            <div class="results-header">
                <h2>Quote result</h2>
                <div class="price" id="price-display">—</div>
            </div>

            <div class="result-meta" id="result-meta">
                No quote yet. Submit a request to see full pricing and configuration details.
            </div>

            <div id="pills"></div>

            <div id="breakdown-container">
                <table id="breakdown-table" style="display:none;">
                    <thead>
                    <tr>
                        <th>Segment</th>
                        <th>Code</th>
                        <th>Description</th>
                        <th>Adder</th>
                    </tr>
                    </thead>
                    <tbody id="breakdown-body"></tbody>
                </table>
            </div>

            <div class="disclaimer">
                Demo only: pricing and options shown here are sample data, not production pricing.
            </div>
        </section>
    </div>
</div>

<script>
    const modelSelect = document.getElementById("model");
    const modeSelect = document.getElementById("mode");
    const partNumberField = document.getElementById("part-number-field");
    const nlField = document.getElementById("nl-field");
    const quoteButton = document.getElementById("quote-button");
    const statusText = document.getElementById("status-text");
    const errorText = document.getElementById("error-text");

    const priceDisplay = document.getElementById("price-display");
    const resultMeta = document.getElementById("result-meta");
    const pills = document.getElementById("pills");
    const breakdownTable = document.getElementById("breakdown-table");
    const breakdownBody = document.getElementById("breakdown-body");

    modeSelect.addEventListener("change", () => {
        if (modeSelect.value === "part_number") {
            partNumberField.style.display = "";
            nlField.style.display = "none";
        } else {
            partNumberField.style.display = "none";
            nlField.style.display = "";
        }
    });

    function renderQuoteResult(data) {
        // Expected shape (what your engine already returns):
        // {
        //   ok: true,
        //   model: "QPSAH200S",
        //   part_number: "QPSAH200S-A-M-...",
        //   base_price: 1000,
        //   total_adders: 150,
        //   final_price: 1150,
        //   segments: [{ segment, code, description, adder }, ...]
        // }

        if (!data || data.ok === false) {
            priceDisplay.textContent = "—";
            resultMeta.textContent = data && data.message
                ? data.message
                : "Unable to calculate a quote for this request.";
            breakdownTable.style.display = "none";
            pills.innerHTML = "";
            return;
        }

        const finalPrice = data.final_price != null ? data.final_price : null;
        const basePrice = data.base_price != null ? data.base_price : null;
        const adders = data.total_adders != null ? data.total_adders : null;

        priceDisplay.textContent =
            finalPrice != null ? `$${finalPrice.toLocaleString()}` : "—";

        const modelText = data.model || modelSelect.value;
        const pnText = data.part_number || "";

        resultMeta.textContent = pnText
            ? `${modelText} – ${pnText}`
            : modelText;

        pills.innerHTML = "";

        if (basePrice != null) {
            const pill = document.createElement("span");
            pill.className = "pill";
            pill.textContent = `Base: $${basePrice.toLocaleString()}`;
            pills.appendChild(pill);
        }

        if (adders != null) {
            const pill = document.createElement("span");
            pill.className = "pill";
            pill.textContent = `Adders: $${adders.toLocaleString()}`;
            pills.appendChild(pill);
        }

        if (data.segments && Array.isArray(data.segments) && data.segments.length) {
            breakdownBody.innerHTML = "";
            data.segments.forEach(seg => {
                const tr = document.createElement("tr");
                const tdSegment = document.createElement("td");
                const tdCode = document.createElement("td");
                const tdDesc = document.createElement("td");
                const tdAdder = document.createElement("td");

                tdSegment.textContent = seg.segment ?? "";
                tdCode.textContent = seg.code ?? "";
                tdDesc.textContent = seg.description ?? "";
                tdAdder.textContent =
                    seg.adder != null ? `$${seg.adder.toLocaleString()}` : "";

                tr.appendChild(tdSegment);
                tr.appendChild(tdCode);
                tr.appendChild(tdDesc);
                tr.appendChild(tdAdder);
                breakdownBody.appendChild(tr);
            });
            breakdownTable.style.display = "";
        } else {
            breakdownTable.style.display = "none";
            breakdownBody.innerHTML = "";
        }
    }

    quoteButton.addEventListener("click", async () => {
        errorText.textContent = "";
        statusText.textContent = "Sending request…";
        quoteButton.disabled = true;

        const model = modelSelect.value;
        const mode = modeSelect.value;
        const partNumberInput = document.getElementById("part-number").value.trim();
        const requestText = document.getElementById("request-text").value.trim();

        let payload = { model };

        if (mode === "part_number") {
            payload.mode = "part_number";
            payload.part_number = partNumberInput;
        } else {
            payload.mode = "natural_language";
            payload.request_text = requestText;
        }

        try {
            const response = await fetch("/quote", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            const data = await response.json();
            renderQuoteResult(data);
            statusText.textContent = "Quote updated.";
        } catch (err) {
            console.error(err);
            errorText.textContent = "Something went wrong talking to the server.";
            statusText.textContent = "";
        } finally {
            quoteButton.disabled = false;
        }
    });
</script>
</body>
</html>
