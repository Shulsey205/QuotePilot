<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>QuotePilot Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --bg-page: radial-gradient(circle at top left, #111827 0, #020617 45%, #020617 100%);
        --bg-card: rgba(15, 23, 42, 0.98);
        --bg-card-soft: #020617;
        --border-subtle: rgba(148, 163, 184, 0.3);
        --text-main: #f9fafb;
        --text-muted: #9ca3af;
        --text-soft: #6b7280;
        --primary: #6366f1;
        --primary-strong: #4f46e5;
        --primary-soft: rgba(99, 102, 241, 0.22);
        --button-secondary-bg: #111827;
        --button-secondary-hover: #1f2937;
        --button-outline-bg: #020617;
        --button-outline-border: #374151;
        --shadow-card: 0 20px 60px rgba(15, 23, 42, 0.9);
        --shadow-primary: 0 16px 40px rgba(79, 70, 229, 0.7);
        --input-border: #374151;
        --table-header-bg: #020617;
        --error-bg: #451717;
        --error-border: #7f1d1d;
        --error-text: #fecaca;
        --note-text: #fbbf24;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color: var(--text-main);
        background: var(--bg-page);
        -webkit-font-smoothing: antialiased;
      }

      .page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .shell {
        width: 100%;
        max-width: 960px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      main {
        flex: 1;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 0 24px;
        gap: 16px;
      }

      .brand {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
      }

      .brand-mark {
        width: 28px;
        height: 28px;
        border-radius: 10px;
        background: radial-gradient(circle at 0 0, #a855f7 0, #6366f1 45%, #1d4ed8 100%);
        box-shadow: 0 12px 32px rgba(79, 70, 229, 0.6);
      }

      .brand-name {
        font-size: 19px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #e5e7eb;
      }

      .brand:hover .brand-name {
        opacity: 0.85;
      }

      .header-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }

      .tagline {
        font-size: 13px;
        color: var(--text-muted);
        text-align: right;
      }

      .card {
        background: linear-gradient(
          to bottom right,
          rgba(15, 23, 42, 0.98),
          rgba(15, 23, 42, 0.99)
        );
        border-radius: 18px;
        padding: 22px 24px 20px;
        box-shadow: var(--shadow-card);
        border: 1px solid var(--border-subtle);
      }

      h2 {
        margin: 4px 0 10px 0;
        font-size: 18px;
      }

      .nl-input-wrapper {
        margin-top: 8px;
      }

      textarea {
        width: 100%;
        min-height: 80px;
        border-radius: 10px;
        border: 1px solid var(--input-border);
        padding: 10px 12px;
        resize: vertical;
        font-family: inherit;
        font-size: 14px;
        box-sizing: border-box;
        color: var(--text-main);
        background: var(--bg-card-soft);
      }

      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 1px var(--primary-soft);
      }

      .hint {
        margin-top: 8px;
        font-size: 13px;
        color: var(--text-muted);
      }

      .button-row {
        margin-top: 14px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      button {
        border-radius: 999px;
        border: none;
        padding: 9px 18px;
        font-size: 14px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: radial-gradient(circle at top left, var(--primary), var(--primary-strong));
        color: #ffffff;
        transition: background 0.15s ease, transform 0.05s ease,
          box-shadow 0.1s ease;
        box-shadow: var(--shadow-primary);
      }

      button.secondary {
        background: var(--button-secondary-bg);
        color: var(--text-main);
        box-shadow: none;
      }

      button.outline {
        background: var(--button-outline-bg);
        color: var(--text-main);
        border: 1px solid var(--button-outline-border);
        box-shadow: none;
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
      }

      button:hover:not(:disabled) {
        transform: translateY(-1px);
      }

      button:not(.secondary):not(.outline):hover:not(:disabled) {
        background: radial-gradient(circle at top left, var(--primary-strong), var(--primary));
      }

      button.secondary:hover:not(:disabled) {
        background: var(--button-secondary-hover);
      }

      button.outline:hover:not(:disabled) {
        background: rgba(148, 163, 184, 0.08);
      }

      .status {
        margin-top: 8px;
        font-size: 13px;
        color: var(--text-muted);
      }

      .status.error {
        color: var(--error-text);
      }

      .notes {
        margin-top: 4px;
        font-size: 13px;
        color: var(--note-text);
      }

      .notes ul {
        margin: 4px 0 0 16px;
        padding: 0;
      }

      .notes li {
        margin: 2px 0;
      }

      .error-box {
        display: none;
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--error-border);
        background: var(--error-bg);
        color: var(--error-text);
        font-size: 13px;
      }

      .results-section {
        margin-top: 22px;
        border-top: 1px solid var(--border-subtle);
        padding-top: 18px;
      }

      .results-header {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 24px;
        align-items: baseline;
        margin-bottom: 12px;
      }

      .result-label {
        font-size: 14px;
        color: var(--text-muted);
      }

      .result-value {
        font-size: 16px;
      }

      .result-main {
        margin-right: 24px;
      }

      .price-value {
        font-weight: 600;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 10px;
        font-size: 14px;
      }

      th,
      td {
        border: 1px solid var(--border-subtle);
        padding: 8px 10px;
        text-align: left;
      }

      th {
        background: var(--table-header-bg);
        font-weight: 500;
      }

      .footer-note {
        margin-top: 10px;
        font-size: 12px;
        color: var(--text-soft);
      }

      .action-row {
        margin-top: 16px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .outlook-hint {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
      }

      .advanced-row {
        margin-top: 18px;
        padding-top: 12px;
        border-top: 1px dashed var(--border-subtle);
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        font-size: 13px;
        color: var(--text-soft);
      }

      .advanced-row label {
        font-size: 13px;
        color: var(--text-muted);
      }

      .advanced-row input[type="text"] {
        border-radius: 8px;
        border: 1px solid var(--input-border);
        padding: 6px 8px;
        font-size: 13px;
        font-family: inherit;
        background: var(--bg-card-soft);
        color: var(--text-main);
      }

      .advanced-row input[type="text"]:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 1px var(--primary-soft);
      }

      @media (max-width: 640px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .header-right {
          align-items: flex-start;
        }

        .results-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .advanced-row {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>

  <body>
    <div class="page">
      <div class="shell">
        <header>
          <a href="/" class="brand">
            <div class="brand-mark"></div>
            <div class="brand-name">QuotePilot</div>
          </a>
          <div class="header-right">
            <div class="tagline">
              Demo · Natural language to configured part numbers and quotes
            </div>
          </div>
        </header>

        <main>
          <div class="card">
            <section>
              <h2>Describe what you need</h2>
              <div class="nl-input-wrapper">
                <textarea
                  id="nl-input"
                  placeholder="Example: One inch mag meter, PTFE liner, explosion proof mounting, 4 to 20 mA output."
                ></textarea>
              </div>
              <div class="hint">
                Try: “DP transmitter, 0 to 150 inch range, stainless wetted parts, explosion proof housing”
              </div>

              <div class="button-row">
                <button id="btn-auto-quote" type="button">
                  Generate quote
                </button>
                <button id="btn-clear" type="button" class="secondary">
                  Clear
                </button>
              </div>

              <div class="advanced-row">
                <span>Advanced: price an exact part number</span>
                <label>
                  Model
                  <input
                    type="text"
                    id="model-input"
                    placeholder="QPSAH200S or QPMAG"
                    style="width: 150px;"
                  />
                </label>
                <label>
                  Part number
                  <input
                    type="text"
                    id="part-input"
                    placeholder="Paste full part number"
                    style="min-width: 220px;"
                  />
                </label>
                <button id="btn-exact-quote" type="button" class="outline">
                  Price exact part
                </button>
              </div>

              <div id="status" class="status"></div>
              <div id="notes" class="notes"></div>
              <div id="error-box" class="error-box"></div>
            </section>

            <section
              class="results-section"
              id="results-section"
              style="display: none;"
            >
              <div class="results-header">
                <div class="result-main">
                  <div class="result-label">Model</div>
                  <div class="result-value" id="result-model"></div>
                </div>
                <div class="result-main">
                  <div class="result-label">Part number</div>
                  <div class="result-value" id="result-part-number"></div>
                </div>
                <div>
                  <div class="result-label">Total price</div>
                  <div class="result-value price-value" id="result-price"></div>
                </div>
              </div>

              <div>
                <div class="result-label">Segment breakdown</div>
                <table id="segments-table">
                  <thead>
                    <tr>
                      <th>Segment</th>
                      <th>Code</th>
                      <th>Description</th>
                      <th>Adder</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

              <div class="action-row">
                <button id="btn-download-pdf" type="button" class="outline">
                  Download PDF
                </button>
                <button
                  id="btn-outlook-draft"
                  type="button"
                  class="secondary"
                  disabled
                  title="Create an Outlook draft with this quote attached."
                >
                  Send to Outlook
                </button>
              </div>
              <div class="outlook-hint">
                Send this quote directly to Outlook as a draft email with the quote PDF attached.
              </div>
              <div id="email-status" class="status"></div>

              <div class="footer-note">
                This is a prototype demo of QuotePilot. Prices and configurations
                are for demonstration only.
              </div>
            </section>
          </div>
        </main>
      </div>
    </div>

    <script>
      const statusEl = document.getElementById("status");
      const notesEl = document.getElementById("notes");
      const errorBoxEl = document.getElementById("error-box");
      const nlInputEl = document.getElementById("nl-input");
      const resultsSectionEl = document.getElementById("results-section");
      const modelEl = document.getElementById("result-model");
      const partNumberEl = document.getElementById("result-part-number");
      const priceEl = document.getElementById("result-price");
      const segmentsTableBody = document.querySelector(
        "#segments-table tbody"
      );

      const btnAutoQuote = document.getElementById("btn-auto-quote");
      const btnClear = document.getElementById("btn-clear");
      const btnDownloadPdf = document.getElementById("btn-download-pdf");
      const btnOutlookDraft = document.getElementById("btn-outlook-draft");
      const emailStatusEl = document.getElementById("email-status");

      const modelInputEl = document.getElementById("model-input");
      const partInputEl = document.getElementById("part-input");
      const btnExactQuote = document.getElementById("btn-exact-quote");

      let lastQuote = null;

      function setStatus(message, isError = false) {
        statusEl.textContent = message || "";
        statusEl.classList.toggle("error", !!isError);
      }

      function setNotes(warnings) {
        if (!warnings || !warnings.length) {
          notesEl.textContent = "";
          notesEl.style.display = "none";
          return;
        }
        const items = warnings
          .map((w) => `<li>${w}</li>`)
          .join("");
        notesEl.innerHTML = `<ul>${items}</ul>`;
        notesEl.style.display = "block";
      }

      function clearErrorBox() {
        if (!errorBoxEl) return;
        errorBoxEl.style.display = "none";
        errorBoxEl.innerHTML = "";
      }

      function showErrorBoxFromDetail(detail) {
        if (!errorBoxEl) return;
        if (!detail || detail.error_type !== "part_number_error") {
          errorBoxEl.style.display = "none";
          errorBoxEl.innerHTML = "";
          return;
        }

        const seg = detail.segment || "Unknown segment";
        const invalid = detail.invalid_code || "invalid";
        const valid = Array.isArray(detail.valid_codes)
          ? detail.valid_codes.join(", ")
          : "";
        const message =
          detail.message ||
          `Invalid code ${invalid} for ${seg}${
            valid ? `. Valid codes: ${valid}.` : "."
          }`;

        let html = `<div><strong>Invalid part number</strong></div>`;
        html += `<div>Segment: ${seg}</div>`;
        html += `<div>Invalid code: ${invalid}</div>`;
        if (valid) {
          html += `<div>Valid codes: ${valid}</div>`;
        }
        html += `<div style="margin-top:4px;">${message}</div>`;

        errorBoxEl.innerHTML = html;
        errorBoxEl.style.display = "block";
      }

      function setEmailStatus(message, isError = false) {
        if (!emailStatusEl) return;
        if (!message) {
          emailStatusEl.textContent = "";
          emailStatusEl.classList.remove("error");
          emailStatusEl.innerHTML = "";
          return;
        }
        emailStatusEl.classList.toggle("error", !!isError);
        emailStatusEl.textContent = message;
      }

      function computeTotalPrice(basePrice, segments) {
        const base =
          typeof basePrice === "number" && !isNaN(basePrice) ? basePrice : 0;
        let adders = 0;
        if (Array.isArray(segments)) {
          for (const seg of segments) {
            const a = seg && typeof seg.adder === "number" ? seg.adder : 0;
            if (!isNaN(a)) {
              adders += a;
            }
          }
        }
        return base + adders;
      }

      function renderQuote(flatResult) {
        if (!flatResult || !flatResult.success) {
          resultsSectionEl.style.display = "none";
          lastQuote = null;
          if (btnOutlookDraft) {
            btnOutlookDraft.disabled = true;
          }
          setEmailStatus("");
          setNotes(null);
          return;
        }

        clearErrorBox();

        const model = flatResult.model || "";
        const partNumber =
          flatResult.part_number || flatResult.partNumber || "";
        const segments = Array.isArray(flatResult.segments)
          ? flatResult.segments
          : [];

        const basePrice =
          typeof flatResult.base_price === "number"
            ? flatResult.base_price
            : typeof flatResult.total_price === "number"
            ? flatResult.total_price
            : 0;

        const totalPrice = computeTotalPrice(basePrice, segments);
        const currency = flatResult.currency || "USD";

        modelEl.textContent = model;
        partNumberEl.textContent = partNumber;
        priceEl.textContent =
          typeof totalPrice === "number"
            ? "$" + totalPrice.toFixed(2)
            : "";

        segmentsTableBody.innerHTML = "";

        for (const seg of segments) {
          const tr = document.createElement("tr");
          const label = seg.label || seg.name || seg.key || "";
          const code = seg.code || "";
          const desc = seg.description || "";
          const adder =
            typeof seg.adder === "number"
              ? "$" + seg.adder.toFixed(2)
              : "$0.00";

          tr.innerHTML = `
            <td>${label}</td>
            <td>${code}</td>
            <td>${desc}</td>
            <td>${adder}</td>
          `;
          segmentsTableBody.appendChild(tr);
        }

        resultsSectionEl.style.display = "block";
        lastQuote = {
          model,
          partNumber,
          totalPrice,
          segments,
          currency,
        };

        if (btnOutlookDraft) {
          btnOutlookDraft.disabled = false;
          btnOutlookDraft.title =
            "Create an Outlook draft with this quote attached.";
        }

        setNotes(flatResult.warnings || []);
        setEmailStatus("");
      }

      function formatSegmentName(segKey) {
        if (!segKey) return "this segment";
        const spaced = String(segKey)
          .replace(/_/g, " ")
          .trim()
          .toLowerCase();
        return spaced.charAt(0).toUpperCase() + spaced.slice(1);
      }

      function extractErrorMessage(status, bodyText, json) {
        if (json && json.detail) {
          const detail = json.detail;

          if (Array.isArray(detail)) {
            const msgs = detail
              .map((d) => d.msg || d.message || "")
              .filter(Boolean);
            if (msgs.length > 0) {
              return msgs.join("; ");
            }
          }

          if (typeof detail === "string") {
            return detail;
          }

          if (typeof detail === "object") {
            if (detail.error_type === "part_number_error") {
              const segKey = detail.segment || "";
              const friendlySeg = formatSegmentName(segKey);
              const invalid = detail.invalid_code || "invalid code";
              const valid = Array.isArray(detail.valid_codes)
                ? detail.valid_codes.join(", ")
                : null;

              let msg = `Invalid code ${invalid} for ${friendlySeg}.`;
              if (valid) {
                msg += ` Valid codes: ${valid}.`;
              }
              return msg;
            }

            if (detail.message) {
              return detail.message;
            }

            return JSON.stringify(detail);
          }
        }

        if (bodyText && bodyText.trim()) {
          return bodyText.trim();
        }

        return "An error occurred while generating the quote.";
      }

      async function requestAutoQuote() {
        const description = nlInputEl.value.trim();
        if (!description) {
          setStatus("Please enter a brief description of what you need.", true);
          setNotes(null);
          clearErrorBox();
          return;
        }

        setStatus("Generating quote…");
        setNotes(null);
        clearErrorBox();
        btnAutoQuote.disabled = true;
        if (btnExactQuote) {
          btnExactQuote.disabled = true;
        }
        setEmailStatus("");
        if (btnOutlookDraft) {
          btnOutlookDraft.disabled = true;
        }

        try {
          const body = { description };

          const response = await fetch("/auto-quote", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          const text = await response.text();
          let json = null;
          try {
            json = JSON.parse(text);
          } catch (_) {
            json = null;
          }

          if (!response.ok) {
            console.error("AUTO-QUOTE error body:", text);
            const message = extractErrorMessage(response.status, text, json);
            setStatus(message, true);
            renderQuote(null);
            return;
          }

          const data = json || {};
          const flatResult = { success: true, ...data };

          renderQuote(flatResult);
          setStatus("Quote generated.");
        } catch (err) {
          console.error(err);
          setStatus("An error occurred while generating the quote.", true);
          renderQuote(null);
        } finally {
          btnAutoQuote.disabled = false;
          if (btnExactQuote) btnExactQuote.disabled = false;
        }
      }

      async function requestExactQuote() {
        const model = (modelInputEl.value || "").trim();
        const partNumber = (partInputEl.value || "").trim();

        if (!model) {
          setStatus("Enter a model before pricing an exact part number.", true);
          return;
        }
        if (!partNumber) {
          setStatus("Enter a full part number to price.", true);
          return;
        }

        setStatus("Pricing exact part number…");
        setNotes(null);
        clearErrorBox();
        btnExactQuote.disabled = true;
        if (btnAutoQuote) btnAutoQuote.disabled = true;
        setEmailStatus("");
        if (btnOutlookDraft) btnOutlookDraft.disabled = true;

        try {
          const body = { model, part_number: partNumber };

          const response = await fetch("/quote", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          const text = await response.text();
          let json = null;
          try {
            json = JSON.parse(text);
          } catch (_) {
            json = null;
          }

          if (!response.ok) {
            console.error("QUOTE error body:", text);
            const detail = json && json.detail ? json.detail : null;

            if (detail && detail.error_type === "part_number_error") {
              showErrorBoxFromDetail(detail);
              const msg = extractErrorMessage(response.status, text, json);
              setStatus(msg, true);
              renderQuote(null);
            } else {
              setStatus(
                extractErrorMessage(response.status, text, json),
                true
              );
              renderQuote(null);
            }
            return;
          }

          clearErrorBox();
          const data = json || {};
          const flatResult = { success: true, ...data };

          renderQuote(flatResult);
          setStatus("Exact part number quote generated.");
        } catch (err) {
          console.error(err);
          setStatus("An error occurred while pricing the part number.", true);
          renderQuote(null);
        } finally {
          btnExactQuote.disabled = false;
          if (btnAutoQuote) btnAutoQuote.disabled = false;
        }
      }

      function clearForm() {
        nlInputEl.value = "";
        if (modelInputEl) modelInputEl.value = "";
        if (partInputEl) partInputEl.value = "";
        renderQuote(null);
        setStatus("");
        setNotes(null);
        clearErrorBox();
        setEmailStatus("");
      }

      async function downloadPdf() {
        if (!lastQuote || !lastQuote.partNumber) {
          setStatus("Generate a quote before downloading a PDF.", true);
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "pt", format: "a4" });

        const marginLeft = 50;
        let y = 60;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(20);
        doc.text("QuotePilot", marginLeft, y);
        y += 8;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.setTextColor(120);
        doc.text("Generated quote (demo)", marginLeft, y);
        doc.setTextColor(0);
        y += 24;

        doc.setLineWidth(0.5);
        doc.line(marginLeft, y, 545, y);
        y += 24;

        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.text("Model:", marginLeft, y);
        doc.setFont("helvetica", "normal");
        doc.text(String(lastQuote.model || ""), marginLeft + 80, y);
        y += 18;

        doc.setFont("helvetica", "bold");
        doc.text("Part number:", marginLeft, y);
        doc.setFont("helvetica", "normal");
        doc.text(String(lastQuote.partNumber || ""), marginLeft + 80, y);
        y += 18;

        doc.setFont("helvetica", "bold");
        doc.text("Total price:", marginLeft, y);
        doc.setFont("helvetica", "normal");
        if (typeof lastQuote.totalPrice === "number") {
          doc.text(
            "$" + lastQuote.totalPrice.toFixed(2),
            marginLeft + 80,
            y
          );
        }
        y += 28;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("Segment breakdown", marginLeft, y);
        y += 14;

        const colX = [
          marginLeft,
          marginLeft + 130,
          marginLeft + 230,
          marginLeft + 430,
        ];
        doc.setFontSize(10);
        doc.text("Segment", colX[0], y);
        doc.text("Code", colX[1], y);
        doc.text("Description", colX[2], y);
        doc.text("Adder", colX[3], y);
        y += 10;

        doc.setLineWidth(0.3);
        doc.line(marginLeft, y, 545, y);
        y += 12;

        doc.setFont("helvetica", "normal");
        if (Array.isArray(lastQuote.segments)) {
          for (const seg of lastQuote.segments) {
            if (y > 760) {
              doc.addPage();
              y = 60;
            }
            const label = String(seg.label || seg.name || seg.key || "");
            const code = String(seg.code || "");
            const desc = String(seg.description || "");
            const adder =
              typeof seg.adder === "number"
                ? "$" + seg.adder.toFixed(2)
                : "$0.00";

            doc.text(label, colX[0], y);
            doc.text(code, colX[1], y);
            doc.text(desc, colX[2], y);
            doc.text(adder, colX[3], y);
            y += 14;
          }
        }

        y += 20;
        doc.setFontSize(9);
        doc.setTextColor(120);
        doc.text(
          "This PDF is generated by the QuotePilot demo. Values are for demonstration only.",
          marginLeft,
          y
        );

        doc.save(
          (lastQuote.partNumber || "QuotePilot_Quote") + ".pdf"
        );
      }

      async function sendToOutlook() {
        if (!lastQuote || !lastQuote.partNumber) {
          setEmailStatus(
            "Generate a quote before sending it to Outlook.",
            true
          );
          return;
        }

        setEmailStatus("Creating Outlook draft…");
        if (btnOutlookDraft) btnOutlookDraft.disabled = true;

        const payload = {
          quote: {
            model: lastQuote.model,
            part_number: lastQuote.partNumber,
            total_price: lastQuote.totalPrice,
            currency: lastQuote.currency || "USD",
            segments: Array.isArray(lastQuote.segments)
              ? lastQuote.segments
              : [],
          },
        };

        try {
          const response = await fetch("/create-outlook-draft", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (response.status === 401) {
            setEmailStatus(
              "Not authenticated with Microsoft. Redirecting to sign in…",
              true
            );
            window.location.href = "/auth/login";
            return;
          }

          if (!response.ok) {
            const text = await response.text();
            console.error("Draft error body:", text);
            throw new Error("Server returned status " + response.status);
          }

          const data = await response.json();

          if (data.status === "ok") {
            const message = "Outlook draft created successfully.";
            if (emailStatusEl) {
              emailStatusEl.classList.remove("error");
              if (data.web_link) {
                emailStatusEl.innerHTML =
                  message +
                  ' <a href="' +
                  data.web_link +
                  '" target="_blank" rel="noopener noreferrer">Open in Outlook</a>';
              } else {
                emailStatusEl.textContent = message;
              }
            }
          } else {
            setEmailStatus(
              data.message ||
                "There was a problem creating the Outlook draft.",
              true
            );
          }
        } catch (err) {
          console.error(err);
          setEmailStatus(
            "There was a problem creating the Outlook draft.",
            true
          );
        } finally {
          if (btnOutlookDraft && lastQuote) {
            btnOutlookDraft.disabled = false;
          }
        }
      }

      btnAutoQuote.addEventListener("click", requestAutoQuote);
      btnClear.addEventListener("click", clearForm);
      btnDownloadPdf.addEventListener("click", downloadPdf);
      btnOutlookDraft.addEventListener("click", sendToOutlook);
      btnExactQuote.addEventListener("click", requestExactQuote);

      nlInputEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && (event.metaKey || event.ctrlKey)) {
          event.preventDefault();
          requestAutoQuote();
        }
      });
    </script>
  </body>
</html>
