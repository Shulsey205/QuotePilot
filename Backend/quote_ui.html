<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>QuotePilot Demo UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 24px;
        background: #f5f5f7;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      }

      h1 {
        margin-top: 0;
        font-size: 24px;
      }

      label {
        display: block;
        margin-bottom: 4px;
        font-size: 14px;
      }

      select,
      input[type="text"] {
        width: 100%;
        padding: 8px 10px;
        margin-bottom: 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 14px;
        box-sizing: border-box;
      }

      button {
        padding: 8px 16px;
        font-size: 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        background: #2563eb;
        color: #ffffff;
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }

      .row > div {
        flex: 1 1 250px;
      }

      .result,
      .error {
        margin-top: 20px;
        padding: 12px;
        border-radius: 8px;
        font-size: 13px;
        white-space: pre-wrap;
        background: #f3f4f6;
      }

      .error {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 12px;
        font-size: 13px;
      }

      th,
      td {
        border: 1px solid #e5e7eb;
        padding: 6px 8px;
        text-align: left;
      }

      th {
        background: #f9fafb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>QuotePilot Demo</h1>
      <p style="font-size: 14px; margin-top: 4px;">
        Select a model, enter or adjust the part number, and get a structured quote result from the backend engine.
      </p>

      <form id="quote-form">
        <div class="row">
          <div>
            <label for="model">Model</label>
            <select id="model" name="model">
              <!-- Fallback defaults; script will try to load live engine list -->
              <option value="QPSAH200S">QPSAH200S (DP transmitter)</option>
              <option value="QPMAG">QPMAG (Magnetic flowmeter)</option>
            </select>
          </div>
          <div>
            <label for="part_number">Part number</label>
            <input
              type="text"
              id="part_number"
              name="part_number"
              placeholder="QPSAH200S-A-M-G-3-C-3-1-1-C-1-02 or QPMAG-1-C-SR-316-150-R-4-0-00-00"
            />
          </div>
        </div>

        <button type="submit" id="quote-button">Get quote</button>
      </form>

      <div id="error-box" class="error" style="display: none;"></div>
      <div id="result-box" class="result" style="display: none;"></div>
      <div id="segments-box" class="result" style="display: none;"></div>
    </div>

    <script>
      // Known good "standard" part numbers per model
      const DEFAULT_PARTS = {
        QPSAH200S: "QPSAH200S-A-M-G-3-C-3-1-1-C-1-02",
        QPMAG: "QPMAG-1-C-SR-316-150-R-4-0-00-00",
      };

      function applyDefaultPartNumber() {
        const modelSelect = document.getElementById("model");
        const partInput = document.getElementById("part_number");
        const model = (modelSelect.value || "").trim();

        if (DEFAULT_PARTS[model]) {
          partInput.value = DEFAULT_PARTS[model];
        }
      }

      async function loadEngines() {
        try {
          const res = await fetch("/engines");
          if (!res.ok) {
            applyDefaultPartNumber();
            return;
          }
          const data = await res.json();
          if (!data || !Array.isArray(data.models)) {
            applyDefaultPartNumber();
            return;
          }

          const select = document.getElementById("model");
          const current = select.value;

          select.innerHTML = "";

          data.models.forEach(function (m) {
            const opt = document.createElement("option");
            opt.value = m;
            opt.textContent = m;
            select.appendChild(opt);
          });

          // Try to keep previous selection if it still exists
          if (data.models.includes(current)) {
            select.value = current;
          }

          applyDefaultPartNumber();
        } catch (err) {
          applyDefaultPartNumber();
        }
      }

      function buildSegmentsTable(segments) {
        if (!Array.isArray(segments) || segments.length === 0) {
          return "";
        }

        let html = "";
        html += "<strong>Part number breakdown</strong>";
        html += "<table>";
        html += "<thead><tr>";
        html += "<th>#</th>";
        html += "<th>Segment</th>";
        html += "<th>Code</th>";
        html += "<th>Description</th>";
        html += "<th>Adder</th>";
        html += "</tr></thead>";
        html += "<tbody>";

        segments.forEach(function (seg) {
          html += "<tr>";
          html += "<td>" + (seg.segment_index ?? "") + "</td>";
          html += "<td>" + (seg.segment_name ?? "") + "</td>";
          html += "<td>" + (seg.code ?? "") + "</td>";
          html += "<td>" + (seg.description ?? "") + "</td>";
          html += "<td>" + (seg.adder ?? 0) + "</td>";
          html += "</tr>";
        });

        html += "</tbody></table>";
        return html;
      }

      async function submitQuote(event) {
        event.preventDefault();

        const btn = document.getElementById("quote-button");
        const errorBox = document.getElementById("error-box");
        const resultBox = document.getElementById("result-box");
        const segmentsBox = document.getElementById("segments-box");

        errorBox.style.display = "none";
        resultBox.style.display = "none";
        segmentsBox.style.display = "none";
        errorBox.textContent = "";
        resultBox.textContent = "";
        segmentsBox.innerHTML = "";

        const model = document.getElementById("model").value.trim();
        const partNumber = document.getElementById("part_number").value.trim();

        if (!model || !partNumber) {
          errorBox.textContent = "Model and part number are required.";
          errorBox.style.display = "block";
          return;
        }

        btn.disabled = true;
        btn.textContent = "Quoting...";

        try {
          const res = await fetch("/quote", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: model,
              part_number: partNumber,
            }),
          });

          const data = await res.json();

          if (!res.ok || data.ok === false) {
            let msg = data.error || data.detail || "Unknown error";
            if (data.segment) {
              msg += "\nSegment: " + data.segment;
            }
            if (data.invalid_code) {
              msg += "\nInvalid code: " + data.invalid_code;
            }
            if (Array.isArray(data.valid_codes) && data.valid_codes.length > 0) {
              msg += "\nValid codes: " + data.valid_codes.join(", ");
            }
            errorBox.textContent = msg;
            errorBox.style.display = "block";
            return;
          }

          // Summary text
          let text = "";
          text += "Model: " + (data.model || "") + "\n";
          text += "Input part number: " + (data.input_part_number || "") + "\n";
          text += "Normalized part number: " + (data.normalized_part_number || "") + "\n";
          text += "Base price: " + data.base_price + "\n";
          text += "Adders total: " + data.adders_total + "\n";
          text += "Final price: " + data.final_price + "\n";

          resultBox.textContent = text;
          resultBox.style.display = "block";

          // Segment breakdown table
          const segmentsHtml = buildSegmentsTable(data.segments || []);
          if (segmentsHtml) {
            segmentsBox.innerHTML = segmentsHtml;
            segmentsBox.style.display = "block";
          }
        } catch (err) {
          errorBox.textContent = "Request failed: " + err;
          errorBox.style.display = "block";
        } finally {
          btn.disabled = false;
          btn.textContent = "Get quote";
        }
      }

      document.getElementById("quote-form").addEventListener("submit", submitQuote);
      document.getElementById("model").addEventListener("change", applyDefaultPartNumber);
      loadEngines();
    </script>
  </body>
</html>
