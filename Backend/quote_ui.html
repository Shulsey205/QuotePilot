<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <title>QuotePilot Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --bg-page: #f3f4f6;
        --bg-card: #ffffff;
        --bg-card-soft: #f9fafb;
        --border-subtle: #e5e7eb;
        --text-main: #111827;
        --text-muted: #6b7280;
        --text-soft: #9ca3af;
        --primary: #2563eb;
        --primary-strong: #1d4ed8;
        --primary-soft: rgba(37, 99, 235, 0.08);
        --button-secondary-bg: #e5e7eb;
        --button-secondary-hover: #d1d5db;
        --button-outline-bg: #ffffff;
        --button-outline-border: #d1d5db;
        --shadow-card: 0 8px 20px rgba(15, 23, 42, 0.08);
        --shadow-primary: 0 8px 20px rgba(37, 99, 235, 0.45);
        --input-border: #d1d5db;
        --table-header-bg: #f9fafb;
      }

      html[data-theme="dark"] {
        --bg-page: #020617;
        --bg-card: #020617;
        --bg-card-soft: #020617;
        --border-subtle: #1f2937;
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;
        --text-soft: #6b7280;
        --primary: #60a5fa;
        --primary-strong: #3b82f6;
        --primary-soft: rgba(96, 165, 250, 0.2);
        --button-secondary-bg: #111827;
        --button-secondary-hover: #1f2937;
        --button-outline-bg: #020617;
        --button-outline-border: #374151;
        --shadow-card: 0 12px 30px rgba(15, 23, 42, 0.9);
        --shadow-primary: 0 10px 26px rgba(59, 130, 246, 0.6);
        --input-border: #374151;
        --table-header-bg: #020617;
      }

      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color: var(--text-main);
        background-color: var(--bg-page);
      }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg-page);
      }

      .page {
        max-width: 960px;
        margin: 24px auto 40px auto;
        padding: 16px;
      }

      .card {
        background: var(--bg-card);
        border-radius: 10px;
        padding: 20px 24px;
        box-shadow: var(--shadow-card);
        border: 1px solid var(--border-subtle);
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 20px;
      }

      .logo-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-svg {
        width: 120px;
        height: auto;
      }

      .header-text {
        display: flex;
        flex-direction: column;
      }

      .tagline {
        font-size: 14px;
        color: var(--text-muted);
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .theme-toggle {
        border-radius: 999px;
        border: 1px solid var(--button-outline-border);
        padding: 6px 12px;
        font-size: 13px;
        background: var(--button-outline-bg);
        color: var(--text-main);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .theme-toggle span.icon {
        font-size: 14px;
      }

      h2 {
        margin: 18px 0 10px 0;
        font-size: 18px;
      }

      .nl-input-wrapper {
        margin-top: 8px;
      }

      textarea {
        width: 100%;
        min-height: 80px;
        border-radius: 8px;
        border: 1px solid var(--input-border);
        padding: 10px 12px;
        resize: vertical;
        font-family: inherit;
        font-size: 14px;
        box-sizing: border-box;
        color: var(--text-main);
        background: var(--bg-card-soft);
      }

      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 1px var(--primary-soft);
      }

      .button-row {
        margin-top: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      button {
        border-radius: 8px;
        border: none;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: var(--primary);
        color: #ffffff;
        transition: background 0.15s ease, transform 0.05s ease,
          box-shadow 0.1s ease;
        box-shadow: var(--shadow-primary);
      }

      button.secondary {
        background: var(--button-secondary-bg);
        color: var(--text-main);
        box-shadow: none;
      }

      button.outline {
        background: var(--button-outline-bg);
        color: var(--text-main);
        border: 1px solid var(--button-outline-border);
        box-shadow: none;
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
      }

      button:hover:not(:disabled) {
        background: var(--primary-strong);
        transform: translateY(-1px);
      }

      button.secondary:hover:not(:disabled) {
        background: var(--button-secondary-hover);
      }

      button.outline:hover:not(:disabled) {
        background: rgba(148, 163, 184, 0.08);
      }

      .status {
        margin-top: 8px;
        font-size: 13px;
        color: var(--text-muted);
      }

      .status.error {
        color: #f97373;
      }

      .results-section {
        margin-top: 22px;
        border-top: 1px solid var(--border-subtle);
        padding-top: 18px;
      }

      .results-header {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 24px;
        align-items: baseline;
        margin-bottom: 12px;
      }

      .result-label {
        font-size: 14px;
        color: var(--text-muted);
      }

      .result-value {
        font-size: 16px;
      }

      .result-main {
        margin-right: 24px;
      }

      .price-value {
        font-weight: 600;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 10px;
        font-size: 14px;
      }

      th,
      td {
        border: 1px solid var(--border-subtle);
        padding: 8px 10px;
        text-align: left;
      }

      th {
        background: var(--table-header-bg);
        font-weight: 500;
      }

      .footer-note {
        margin-top: 10px;
        font-size: 12px;
        color: var(--text-soft);
      }

      .action-row {
        margin-top: 16px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .outlook-hint {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
      }

      @media (max-width: 640px) {
        .results-header {
          flex-direction: column;
          align-items: flex-start;
        }

        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .header-actions {
          align-self: stretch;
          justify-content: flex-end;
        }
      }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>

  <body>
    <div class="page">
      <div class="card">
        <header>
          <div class="logo-wrapper">
            <svg
              class="logo-svg"
              viewBox="0 0 220 120"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M10 20 L210 60 L10 100 L40 60 Z"
                fill="none"
                stroke="#333"
                stroke-width="4"
                stroke-linejoin="round"
                stroke-linecap="round"
              />
              <text
                x="110"
                y="115"
                font-family="Arial, Helvetica, sans-serif"
                font-size="28"
                text-anchor="middle"
                fill="#333"
              >
                QuotePilot
              </text>
            </svg>
          </div>
          <div class="header-text">
            <div class="tagline">
              Natural language to configured part numbers and quotes
            </div>
          </div>
          <div class="header-actions">
            <button id="theme-toggle" type="button" class="theme-toggle">
              <span class="icon" id="theme-icon">ðŸŒ™</span>
              <span id="theme-label">Dark</span>
            </button>
          </div>
        </header>

        <section>
          <h2>Describe what you need</h2>
          <div class="nl-input-wrapper">
            <textarea
              id="nl-input"
              placeholder="Example: One inch mag meter, PTFE liner, explosion-proof mounting, 4â€“20 mA output."
            ></textarea>
          </div>
          <div class="button-row">
            <button id="btn-auto-quote" type="button">
              Generate quote
            </button>
            <button id="btn-clear" type="button" class="secondary">
              Clear
            </button>
          </div>
          <div id="status" class="status"></div>
        </section>

        <section
          class="results-section"
          id="results-section"
          style="display: none;"
        >
          <div class="results-header">
            <div class="result-main">
              <div class="result-label">Model</div>
              <div class="result-value" id="result-model"></div>
            </div>
            <div class="result-main">
              <div class="result-label">Part number</div>
              <div class="result-value" id="result-part-number"></div>
            </div>
            <div>
              <div class="result-label">Total price</div>
              <div class="result-value price-value" id="result-price"></div>
            </div>
          </div>

          <div>
            <div class="result-label">Segment breakdown</div>
            <table id="segments-table">
              <thead>
                <tr>
                  <th>Segment</th>
                  <th>Code</th>
                  <th>Description</th>
                  <th>Adder</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="action-row">
            <button id="btn-download-pdf" type="button" class="outline">
              Download PDF
            </button>
            <button
              id="btn-outlook-draft"
              type="button"
              class="secondary"
              disabled
              title="Create an Outlook draft with this quote attached."
            >
              Send to Outlook
            </button>
          </div>
          <div class="outlook-hint">
            Send this quote directly to Outlook as a draft email with the quote
            PDF attached.
          </div>
          <div id="email-status" class="status"></div>

          <div class="footer-note">
            This is a prototype demo of QuotePilot. Prices and configurations
            are for demonstration only.
          </div>
        </section>
      </div>
    </div>

    <script>
      // Theme handling shared logic
      function applyTheme(theme) {
        const html = document.documentElement;
        html.setAttribute("data-theme", theme);
        localStorage.setItem("qp_theme", theme);

        const label = document.getElementById("theme-label");
        const icon = document.getElementById("theme-icon");
        if (label && icon) {
          if (theme === "dark") {
            label.textContent = "Light";
            icon.textContent = "â˜€ï¸";
          } else {
            label.textContent = "Dark";
            icon.textContent = "ðŸŒ™";
          }
        }
      }

      (function initThemeFromStorage() {
        const stored = localStorage.getItem("qp_theme");
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;

        if (stored === "dark" || stored === "light") {
          applyTheme(stored);
        } else {
          applyTheme(prefersDark ? "dark" : "light");
        }
      })();

      document
        .getElementById("theme-toggle")
        .addEventListener("click", () => {
          const current =
            document.documentElement.getAttribute("data-theme") || "light";
          applyTheme(current === "light" ? "dark" : "light");
        });

      const statusEl = document.getElementById("status");
      const nlInputEl = document.getElementById("nl-input");
      const resultsSectionEl = document.getElementById("results-section");
      const modelEl = document.getElementById("result-model");
      const partNumberEl = document.getElementById("result-part-number");
      const priceEl = document.getElementById("result-price");
      const segmentsTableBody = document.querySelector(
        "#segments-table tbody"
      );

      const btnAutoQuote = document.getElementById("btn-auto-quote");
      const btnClear = document.getElementById("btn-clear");
      const btnDownloadPdf = document.getElementById("btn-download-pdf");
      const btnOutlookDraft = document.getElementById("btn-outlook-draft");
      const emailStatusEl = document.getElementById("email-status");

      let lastQuote = null;

      function setStatus(message, isError = false) {
        if (!message) {
          statusEl.textContent = "";
          statusEl.classList.remove("error");
          return;
        }
        statusEl.textContent = message;
        if (isError) {
          statusEl.classList.add("error");
        } else {
          statusEl.classList.remove("error");
        }
      }

      function setEmailStatus(message, isError = false) {
        if (!emailStatusEl) return;
        if (!message) {
          emailStatusEl.textContent = "";
          emailStatusEl.classList.remove("error");
          emailStatusEl.innerHTML = "";
          return;
        }
        emailStatusEl.classList.remove("error");
        if (isError) {
          emailStatusEl.classList.add("error");
        }
        emailStatusEl.textContent = message;
      }

      function computeTotalPrice(basePrice, segments) {
        const base =
          typeof basePrice === "number" && !isNaN(basePrice) ? basePrice : 0;
        let adders = 0;
        if (Array.isArray(segments)) {
          for (const seg of segments) {
            const a = seg && typeof seg.adder === "number" ? seg.adder : 0;
            if (!isNaN(a)) {
              adders += a;
            }
          }
        }
        return base + adders;
      }

      function renderQuote(flatResult) {
        if (!flatResult || !flatResult.success) {
          resultsSectionEl.style.display = "none";
          lastQuote = null;
          if (btnOutlookDraft) {
            btnOutlookDraft.disabled = true;
          }
          setEmailStatus("");
          return;
        }

        const model = flatResult.model || "";
        const partNumber =
          flatResult.part_number || flatResult.partNumber || "";
        const segments = Array.isArray(flatResult.segments)
          ? flatResult.segments
          : [];

        const basePrice =
          typeof flatResult.base_price === "number"
            ? flatResult.base_price
            : typeof flatResult.total_price === "number"
            ? flatResult.total_price
            : 0;

        const totalPrice = computeTotalPrice(basePrice, segments);
        const currency = flatResult.currency || "USD";

        modelEl.textContent = model;
        partNumberEl.textContent = partNumber;
        priceEl.textContent =
          typeof totalPrice === "number"
            ? "$" + totalPrice.toFixed(2)
            : "";

        segmentsTableBody.innerHTML = "";

        for (const seg of segments) {
          const tr = document.createElement("tr");
          const label = seg.label || seg.name || seg.key || "";
          const code = seg.code || "";
          const desc = seg.description || "";
          const adder =
            typeof seg.adder === "number"
              ? "$" + seg.adder.toFixed(2)
              : "$0.00";

          tr.innerHTML = `
            <td>${label}</td>
            <td>${code}</td>
            <td>${desc}</td>
            <td>${adder}</td>
          `;
          segmentsTableBody.appendChild(tr);
        }

        resultsSectionEl.style.display = "block";
        lastQuote = {
          model,
          partNumber,
          totalPrice,
          segments,
          currency,
        };

        if (btnOutlookDraft) {
          btnOutlookDraft.disabled = false;
          btnOutlookDraft.title =
            "Create an Outlook draft with this quote attached.";
        }
        setEmailStatus("");
      }

      // New helper: extract a good error message from FastAPI responses
      function extractErrorMessage(status, bodyText, json) {
        // PartNumberError: {"detail": { ... }}
        if (json && json.detail) {
          const detail = json.detail;

          // Validation errors: [{"msg": "...", ...}]
          if (Array.isArray(detail)) {
            const msgs = detail
              .map((d) => d.msg || d.message || "")
              .filter(Boolean);
            if (msgs.length > 0) {
              return msgs.join("; ");
            }
          }

          // detail is a string
          if (typeof detail === "string") {
            return detail;
          }

          // detail is an object
          if (typeof detail === "object") {
            if (detail.error_type === "part_number_error") {
              const seg = detail.segment || "unknown segment";
              const invalid = detail.invalid_code || "invalid code";
              const valid = Array.isArray(detail.valid_codes)
                ? detail.valid_codes.join(", ")
                : null;

              let msg = `Invalid code "${invalid}" in segment ${seg}.`;
              if (valid) {
                msg += ` Valid options: ${valid}.`;
              }
              return msg;
            }

            if (detail.message) {
              return detail.message;
            }

            return JSON.stringify(detail);
          }
        }

        // If we have plain text from the server, use that
        if (bodyText && bodyText.trim()) {
          return bodyText.trim();
        }

        return "An error occurred while generating the quote.";
      }

      async function requestAutoQuote() {
        const description = nlInputEl.value.trim();
        if (!description) {
          setStatus("Please enter a brief description of what you need.", true);
          return;
        }

        setStatus("Generating quoteâ€¦");
        btnAutoQuote.disabled = true;
        setEmailStatus("");
        if (btnOutlookDraft) {
          btnOutlookDraft.disabled = true;
        }

        try {
          const body = {
            description: description,
          };

          const response = await fetch("/auto-quote", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
          });

          if (!response.ok) {
            const text = await response.text();
            let json = null;
            try {
              json = JSON.parse(text);
            } catch (_) {
              json = null;
            }

            console.error("Server error body:", text);
            const message = extractErrorMessage(response.status, text, json);
            setStatus(message, true);
            renderQuote(null);
            return;
          }

          const data = await response.json();

          const flatResult = {
            success: true,
            ...data,
          };

          renderQuote(flatResult);
          setStatus("Quote generated.");
        } catch (err) {
          console.error(err);
          setStatus("An error occurred while generating the quote.", true);
          renderQuote(null);
        } finally {
          btnAutoQuote.disabled = false;
        }
      }

      function clearForm() {
        nlInputEl.value = "";
        renderQuote(null);
        setStatus("");
        setEmailStatus("");
      }

      async function downloadPdf() {
        if (!lastQuote || !lastQuote.partNumber) {
          setStatus("Generate a quote before downloading a PDF.", true);
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          unit: "pt",
          format: "a4",
        });

        const marginLeft = 50;
        let y = 60;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(20);
        doc.text("QuotePilot", marginLeft, y);
        y += 8;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.setTextColor(120);
        doc.text("Generated quote (demo)", marginLeft, y);
        doc.setTextColor(0);
        y += 24;

        doc.setLineWidth(0.5);
        doc.line(marginLeft, y, 545, y);
        y += 24;

        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.text("Model:", marginLeft, y);
        doc.setFont("helvetica", "normal");
        doc.text(String(lastQuote.model || ""), marginLeft + 80, y);
        y += 18;

        doc.setFont("helvetica", "bold");
        doc.text("Part number:", marginLeft, y);
        doc.setFont("helvetica", "normal");
        doc.text(String(lastQuote.partNumber || ""), marginLeft + 80, y);
        y += 18;

        doc.setFont("helvetica", "bold");
        doc.text("Total price:", marginLeft, y);
        doc.setFont("helvetica", "normal");
        if (typeof lastQuote.totalPrice === "number") {
          doc.text(
            "$" + lastQuote.totalPrice.toFixed(2),
            marginLeft + 80,
            y
          );
        }
        y += 28;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("Segment breakdown", marginLeft, y);
        y += 14;

        const colX = [
          marginLeft,
          marginLeft + 130,
          marginLeft + 230,
          marginLeft + 430,
        ];
        doc.setFontSize(10);
        doc.text("Segment", colX[0], y);
        doc.text("Code", colX[1], y);
        doc.text("Description", colX[2], y);
        doc.text("Adder", colX[3], y);
        y += 10;

        doc.setLineWidth(0.3);
        doc.line(marginLeft, y, 545, y);
        y += 12;

        doc.setFont("helvetica", "normal");
        if (Array.isArray(lastQuote.segments)) {
          for (const seg of lastQuote.segments) {
            if (y > 760) {
              doc.addPage();
              y = 60;
            }
            const label = String(seg.label || seg.name || seg.key || "");
            const code = String(seg.code || "");
            const desc = String(seg.description || "");
            const adder =
              typeof seg.adder === "number"
                ? "$" + seg.adder.toFixed(2)
                : "$0.00";

            doc.text(label, colX[0], y);
            doc.text(code, colX[1], y);
            doc.text(desc, colX[2], y);
            doc.text(adder, colX[3], y);
            y += 14;
          }
        }

        y += 20;
        doc.setFontSize(9);
        doc.setTextColor(120);
        doc.text(
          "This PDF is generated by the QuotePilot demo. Values are for demonstration only.",
          marginLeft,
          y
        );

        doc.save(
          (lastQuote.partNumber || "QuotePilot_Quote") + ".pdf"
        );
      }

      async function sendToOutlook() {
        if (!lastQuote || !lastQuote.partNumber) {
          setEmailStatus(
            "Generate a quote before sending it to Outlook.",
            true
          );
          return;
        }

        setEmailStatus("Creating Outlook draftâ€¦");
        if (btnOutlookDraft) {
          btnOutlookDraft.disabled = true;
        }

        const payload = {
          quote: {
            model: lastQuote.model,
            part_number: lastQuote.partNumber,
            total_price: lastQuote.totalPrice,
            currency: lastQuote.currency || "USD",
            segments: Array.isArray(lastQuote.segments)
              ? lastQuote.segments
              : [],
          },
        };

        try {
          const response = await fetch("/create-outlook-draft", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (response.status === 401) {
            setEmailStatus(
              "Not authenticated with Microsoft. Redirecting to sign inâ€¦",
              true
            );
            window.location.href = "/auth/login";
            return;
          }

          if (!response.ok) {
            const text = await response.text();
            console.error("Draft error body:", text);
            throw new Error("Server returned status " + response.status);
          }

          const data = await response.json();

          if (data.status === "ok") {
            const message = "Outlook draft created successfully.";
            if (emailStatusEl) {
              emailStatusEl.classList.remove("error");
              if (data.web_link) {
                emailStatusEl.innerHTML =
                  message +
                  ' <a href="' +
                  data.web_link +
                  '" target="_blank" rel="noopener noreferrer">Open in Outlook</a>';
              } else {
                emailStatusEl.textContent = message;
              }
            }
          } else {
            setEmailStatus(
              data.message ||
                "There was a problem creating the Outlook draft.",
              true
            );
          }
        } catch (err) {
          console.error(err);
          setEmailStatus(
            "There was a problem creating the Outlook draft.",
            true
          );
        } finally {
          if (btnOutlookDraft && lastQuote) {
            btnOutlookDraft.disabled = false;
          }
        }
      }

      btnAutoQuote.addEventListener("click", requestAutoQuote);
      btnClear.addEventListener("click", clearForm);
      btnDownloadPdf.addEventListener("click", downloadPdf);
      btnOutlookDraft.addEventListener("click", sendToOutlook);

      nlInputEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && (event.metaKey || event.ctrlKey)) {
          event.preventDefault();
          requestAutoQuote();
        }
      });
    </script>
  </body>
</html>
